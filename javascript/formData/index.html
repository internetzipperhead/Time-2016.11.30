<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>FormData</title>
  <link rel="stylesheet" href="/reset.css">
  <link rel="stylesheet" href="/base.css">
</head>
<body>
  <header class="header">
    <h1>学习FormData</h1>
  </header>
  <main class="pad10">
    <input id="file" type="file" class="file" style="display:none" multiple="multiple" accept="image/png, image/jpeg">
    <a href="#" class="btn success upload">upload</a>
    <a href="#" class="btn primary getimg">读取数据</a>
    <a href="#" class="btn danger getdata">读取数据总数</a>
    <a href="#" class="btn warning delete">删除数据</a>
    <div class="pad10 img-wrap">
      <img src="static/a0fefe7bdfce0861c103bf9b5fd1085b" alt="">
    </div>
  </main>

  <script src="/main.js"></script>

  <script>
    let btn = document.querySelector('.upload')
    let getImg = document.querySelector('.getimg')
    let getdata = document.querySelector('.getdata')
    let deleteImg = document.querySelector('.delete')
    let file = document.querySelector('#file')
    let imgElem = document.querySelector('.img-wrap img')

    btn.onclick = () => {
      file.click()
    }

    file.onchange = e => {
      console.info(e.target.files)
      let files = Array.from(e.target.files)
      if (files.length > 1) {
        files.forEach( file => {
          upload(file)
        })
      } else {
        upload(files[0])
      }
    }

    getImg.onclick = () => {
      getImage()
    }

    getdata.onclick = () => {
      getImgList()
    }

    function getImgList() {
      let xhr = new XMLHttpRequest()
      xhr.open('get', '/imglist', true)
      xhr.onload = function() {
        if (this.status == 200) {
          console.log(JSON.parse(this.response))
        }
      }
      xhr.send()
    }

    deleteImg.onclick = () => {
      delete_img()
    }

    function getImage() {
      let reader = new FileReader()
      let xhr = new XMLHttpRequest()
      xhr.open('GET', '/getimg?name=leeing', true)
      xhr.responseType = 'blob'
      xhr.onload = function() {
        if (this.status === 200) {
          console.log(this.response)
          if (this.response.size !== 0) {
            reader.readAsDataURL(this.response)
          }
        }
      }
      xhr.send({name: 'leeing'})
      reader.onload = function() {
        console.log(this)
        imgElem.src = this.result
      }
    }

    function delete_img() {
      let xhr = new XMLHttpRequest()
      xhr.open('delete', '/clearimg', true)
      xhr.onload = function() {
        if (this.status == 200) {
          console.log(this.response)
          
        }
      }
      xhr.send()
    }


    function upload(file) {
      console.log(file)
      let xhr = new XMLHttpRequest()
      xhr.open('POST', '/upload', true)
      let formData = new FormData()
      formData.set('fileName', file)
      xhr.onreadystatechange =function() {
        if (xhr.readyState == 4 && xhr.status === 200) {
          console.log(this.response)
        }
      }
      xhr.onerror = e => {
        console.error(e)
      }
      xhr.send(formData)
    }
  </script>
</body>
</html>